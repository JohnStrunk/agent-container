#!/bin/bash
set -e -o pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common functions
# shellcheck source=vm-common.sh
# shellcheck disable=SC1091
source "$SCRIPT_DIR/vm-common.sh"

# Usage information
usage() {
  cat << EOF
Usage: $0 <local-directory> [workspace-subpath]

Pull directory contents from VM workspace over SSH using rsync.

Arguments:
  local-directory     Local directory to pull into (required)
  workspace-subpath   Optional subdirectory within workspace (default: root)

Examples:
  $0 ./my-project              # Pull from workspace root
  $0 ./my-project myapp        # Pull from workspace/myapp/
  $0 ~/src/foo bar/baz         # Pull from workspace/bar/baz/

Notes:
  - Directory contents are mirrored (uses --delete)
  - Local directory will be created if it doesn't exist
  - Uses rsync for efficient incremental transfers
EOF
}

# Parse arguments
if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
  exit 0
fi

LOCAL_DIR="$1"
WORKSPACE_SUBPATH="${2:-}"

# Create local directory if it doesn't exist
mkdir -p "$LOCAL_DIR"

# Get absolute path
LOCAL_DIR=$(get_absolute_path "$LOCAL_DIR")

# Get VM IP and user
VM_IP=$(get_vm_ip "$SCRIPT_DIR")
VM_USER=$(get_vm_user "$SCRIPT_DIR")

# Check VM reachable
check_vm_reachable "$SCRIPT_DIR" "$VM_IP" "$VM_USER"

# Construct remote path
WORKSPACE_BASE=$(get_vm_workspace_path "$SCRIPT_DIR")
if [[ -z "$WORKSPACE_SUBPATH" ]]; then
  REMOTE_PATH="$WORKSPACE_BASE/"
else
  REMOTE_PATH="$WORKSPACE_BASE/$WORKSPACE_SUBPATH/"
fi

# Check if remote path exists
if ! vm_ssh "$SCRIPT_DIR" "$VM_USER" "$VM_IP" "test -d \"$REMOTE_PATH\""; then
  echo "Error: Remote path '$REMOTE_PATH' does not exist on VM" >&2
  exit 1
fi

# Perform rsync
echo "Pulling from $VM_USER@$VM_IP:$REMOTE_PATH to $LOCAL_DIR"

rsync -avz --delete \
  -e "$(get_rsync_ssh_cmd "$SCRIPT_DIR")" \
  "$VM_USER@$VM_IP:$REMOTE_PATH" \
  "$LOCAL_DIR/"

echo "Done! Directory pulled successfully."
