---
# Lima VM template for agent-vm
# Provides isolated development environment for AI coding agents

# VM backend - QEMU works on both Linux and macOS
vmType: "qemu"

# OS images
images:
  - location: "https://cloud.debian.org/images/cloud/trixie/latest/debian-13-generic-amd64.qcow2"
    arch: "x86_64"

# Default resources (overridable via start command)
cpus: 4
memory: "8GiB"
disk: "100GiB"

# Disable Lima's default mounts (we use forward SSHFS instead)
mounts: []

# SSH configuration
ssh:
  localPort: 0  # Auto-assign port
  loadDotSSHPubKeys: false  # Use Lima-generated keys only
  forwardAgent: false       # Security: no agent forwarding

# Port forwarding (none needed by default)
portForwards: []

# Provisioning scripts
provision:
  # System-level provisioning
  # Note: Lima reads the file from template directory and embeds it
  - mode: system
    file: lima-provision.sh

  # User-level setup (runs as default Lima user)
  - mode: user
    script: |
      #!/bin/bash
      set -e -o pipefail

      # Create workspace directory
      mkdir -p ~/workspace

      # Install Claude Code (must run as user, not root)
      echo "[INFO] Installing Claude Code..."
      curl -fsSL https://claude.ai/install.sh | bash

      # Add ~/.local/bin to PATH in bashrc (idempotent)
      path_export='export PATH="$HOME/.local/bin:$PATH"'
      if ! grep -q "$path_export" ~/.bashrc 2>/dev/null; then
        echo "$path_export" >> ~/.bashrc
      fi

      # Set default directory in bashrc (idempotent)
      if ! grep -q "cd ~/workspace" ~/.bashrc 2>/dev/null; then
        echo "cd ~/workspace" >> ~/.bashrc
      fi

# Firmware (default UEFI)
firmware:
  legacyBIOS: false

# Video display (headless)
video:
  display: "none"

# Network (default user-mode networking)
# Note: Empty networks list uses Lima's default user-mode networking
# The "lima: shared" option is macOS-only, so we omit it for
# cross-platform compatibility
networks: []
