#cloud-config
hostname: ${hostname}
fqdn: ${hostname}.local
manage_etc_hosts: true

write_files:
%{ if gcp_service_account_key != "" ~}
  - path: /etc/google/application_default_credentials.json
    permissions: '0600'
    content: |
      ${indent(6, gcp_service_account_key)}
%{ endif ~}
%{ for path, file_data in homedir_files ~}
  - path: /tmp/homedir/${path}
    permissions: '${file_data.permissions}'
    content: |
      ${indent(6, file_data.content)}
%{ endfor ~}
  - path: /etc/agent-environment
    permissions: '0644'
    content: |
      agent-vm

users:
  - name: ${default_user}
    uid: ${user_uid}
    shell: /bin/bash
    # Constrained sudo access for AI coding agent
    # - apt-get/apt/dpkg: Install system packages and development dependencies
    # - systemctl: Manage services during development (restart nginx, databases, etc.)
    # Note: User already has docker/libvirt/kvm group access, no sudo needed for those
    sudo:
      - "ALL=(ALL) NOPASSWD: /usr/bin/apt-get"
      - "ALL=(ALL) NOPASSWD: /usr/bin/apt"
      - "ALL=(ALL) NOPASSWD: /usr/bin/dpkg"
      - "ALL=(ALL) NOPASSWD: /usr/bin/systemctl"
    ssh_authorized_keys:
%{ for key in ssh_keys ~}
      - ${key}
%{ endfor ~}
  - name: root
    ssh_authorized_keys:
%{ for key in ssh_keys ~}
      - ${key}
%{ endfor ~}

# Enable root login via SSH
ssh_pwauth: false
disable_root: false

# Configure serial console auto-login as root
runcmd:
  # Fix user's primary group to match host GID
  - groupmod -g ${user_gid} ${default_user}
  - usermod -g ${user_gid} ${default_user}
  # Add user to docker group for container access
  - usermod -aG docker ${default_user}
  # Add user to libvirt and kvm groups for virtualization access
  - usermod -aG libvirt ${default_user}
  - usermod -aG kvm ${default_user}
  # Initialize libvirt default storage pool for nested virtualization
  - mkdir -p /var/lib/libvirt/images
  - chmod 755 /var/lib/libvirt/images
  - virsh --connect qemu:///system pool-define-as default dir --target /var/lib/libvirt/images
  - virsh --connect qemu:///system pool-build default
  - virsh --connect qemu:///system pool-start default
  - virsh --connect qemu:///system pool-autostart default
  # Fix AppArmor for terraform-provider-libvirt (issues #126, #920, #882)
  - |
    cat > /etc/apparmor.d/libvirt/TEMPLATE.qemu <<'APPARMOR_EOF'
    #
    # This profile is for the domain whose UUID matches this file.
    #

    #include <tunables/global>

    profile LIBVIRT_TEMPLATE flags=(attach_disconnected) {
      #include <abstractions/libvirt-qemu>

      # Allow access to storage pool images (fix for terraform-provider-libvirt)
      /var/lib/libvirt/images/*.qcow2 rwk,
      /var/lib/libvirt/images/*.img rwk,
      /var/lib/libvirt/images/*.iso rwk,
    }
    APPARMOR_EOF
  - systemctl restart libvirtd
  # Remove pre-existing default network to avoid conflicts in nested scenarios
  - virsh --connect qemu:///system net-undefine default 2>/dev/null || true
  - mkdir -p /etc/systemd/system/serial-getty@ttyS0.service.d
  - |
    cat > /etc/systemd/system/serial-getty@ttyS0.service.d/override.conf <<EOF
    [Service]
    ExecStart=
    ExecStart=-/sbin/agetty --autologin root --noclear %I \$TERM
    EOF
  - systemctl daemon-reload
  - systemctl restart serial-getty@ttyS0.service
  - |
    sed -i 's/^#*PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config
  - systemctl restart sshd
  # Configure Go PATH (unconditional - Go is always installed)
  - mkdir -p /etc/profile.d
  - |
    cat > /etc/profile.d/go-path.sh <<EOF
    export PATH="/usr/local/go/bin:\$PATH"
    EOF
  - chmod 644 /etc/profile.d/go-path.sh
%{ if gcp_service_account_key != "" ~}
  # Configure GCP environment variables for AI agents
  - |
    cat > /etc/profile.d/gcp-ai-agent.sh <<EOF
    export GOOGLE_APPLICATION_CREDENTIALS=/etc/google/application_default_credentials.json
    export ANTHROPIC_VERTEX_PROJECT_ID="${vertex_project_id}"
    export CLOUD_ML_REGION="${vertex_region}"
    export CLAUDE_CODE_USE_VERTEX="true"
    EOF
  - chmod 644 /etc/profile.d/gcp-ai-agent.sh
%{ endif ~}
  # Install Go ${golang_version}
  - curl -fsSL https://go.dev/dl/go${golang_version}.linux-amd64.tar.gz -o /tmp/go.tar.gz
  - tar -C /usr/local -xzf /tmp/go.tar.gz
  - rm -f /tmp/go.tar.gz
  # Install HashiCorp repository and Terraform
  - curl -fsSL https://apt.releases.hashicorp.com/gpg -o /usr/share/keyrings/hashicorp-archive-keyring.asc
  - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/hashicorp-archive-keyring.asc] https://apt.releases.hashicorp.com $(lsb_release -cs) main" > /etc/apt/sources.list.d/hashicorp.list
  - apt-get update
  - apt-get install -y terraform
  # Install uv for Python package management
  - curl -LsSf https://astral.sh/uv/install.sh | sh
  - mv /root/.local/bin/uv /usr/local/bin/uv
  - mv /root/.local/bin/uvx /usr/local/bin/uvx
  # Install Python tools system-wide
  - pip install --break-system-packages ${python_packages}
  # Install hadolint for Dockerfile linting
  - curl -fsSL https://github.com/hadolint/hadolint/releases/download/v${hadolint_version}/hadolint-Linux-x86_64 -o /tmp/hadolint
  - install /tmp/hadolint /usr/local/bin/hadolint
  - rm -f /tmp/hadolint
  # Install AI coding agents globally
  - npm install -g ${npm_packages}

  # Copy all files from /tmp/homedir to user's home directory
  - cp -r /tmp/homedir/. /home/${default_user}/
  - chown -R ${user_uid}:${user_gid} /home/${default_user}
  - rm -rf /tmp/homedir

  # Create workspace directory for Claude Code
  - mkdir -p /home/${default_user}/workspace
  - chown -R ${user_uid}:${user_gid} /home/${default_user}/workspace
  - chmod 755 /home/${default_user}/workspace


package_update: true
package_upgrade: true

packages:
%{ for pkg in split("\n", apt_packages) ~}
%{ if pkg != "" && !startswith(pkg, "#") ~}
  - ${pkg}
%{ endif ~}
%{ endfor ~}
  # VM-specific packages for nested virtualization
  - docker.io
  - qemu-system-x86
  - qemu-guest-agent
  - libvirt-daemon-system
  - libvirt-clients
  - virtinst
  - bridge-utils
  - wget
  - htop

final_message: "System boot complete. Console auto-login enabled for root."
