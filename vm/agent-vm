#!/bin/bash

set -e -o pipefail

WORKTREE_BASE_DIR=~/src/worktrees
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

function list_vms {
  echo "Listing all VMs managed by agent-vm..."
  echo ""
  printf "%-30s %-15s %-15s\n" "VM NAME" "STATUS" "IP ADDRESS"
  printf "%-30s %-15s %-15s\n" "-------" "------" "----------"

  # List all workspaces except default
  terraform workspace list 2>/dev/null | grep -v default | sed 's/^[* ] *//' | \
    while read -r ws; do
      terraform workspace select "$ws" >/dev/null 2>&1

      local vm_name="$ws"
      local vm_ip
      vm_ip=$(terraform output -raw vm_ip 2>/dev/null || echo "N/A")

      local status="unknown"
      if vm_domain_exists "$vm_name"; then
        if vm_is_running "$vm_name"; then
          status="running"
        else
          status="stopped"
        fi
      else
        status="missing"
      fi

      printf "%-30s %-15s %-15s\n" "$vm_name" "$status" "$vm_ip"
    done

  # Return to default workspace
  terraform workspace select default >/dev/null 2>&1
  echo ""
}

function usage {
    cat - <<EOF
agent-vm: Unified VM workflow for AI coding agents

Usage: $0 [options] [-b <branch_name>] [-- command...]

Options:
  -b, --branch <name>         Branch name for git worktree
  --memory <MB>               VM memory in MB (default: 4096, creation only)
  --vcpu <count>              Virtual CPUs (default: 4, creation only)
  --disk <size>               Disk size like 60G (default: 40G, creation only)
  --list                      List all VMs and their status
  --stop                      Stop VM (requires -b)
  --destroy                   Destroy VM and workspace (requires -b)
  --cleanup                   Destroy all stopped VMs
  -h, --help                  Show this help

Arguments:
  command...                  Optional command to execute in VM
                              (connection closes after execution)

Examples:
  $0 -b feature-auth                    # Create/connect to VM
  $0 -b feature-auth -- claude          # Run claude directly
  $0 -b big-build --memory 16384        # Create VM with 16GB RAM
  $0 --list                             # List all VMs
  $0 -b feature-auth --destroy          # Destroy VM

Storage:
  * Worktrees: $WORKTREE_BASE_DIR
  * Terraform state: vm/.terraform/
  * SSH keys: vm/.ssh/vm-ssh-key-<vm-name>

Multi-VM:
  * Each branch gets its own VM via Terraform workspaces
  * Run same command again to reconnect (opens 2nd terminal)
  * VMs persist after exit (not destroyed like containers)
EOF
}

# Parse command line options
BRANCH_NAME=""
VM_COMMAND=()
USE_GIT=0
MEMORY_OVERRIDE=""
VCPU_OVERRIDE=""
DISK_OVERRIDE=""
ACTION=""  # list, stop, destroy, cleanup, or "" for connect

while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--branch)
            BRANCH_NAME="$2"
            shift 2
            ;;
        --memory)
            MEMORY_OVERRIDE="$2"
            shift 2
            ;;
        --vcpu)
            VCPU_OVERRIDE="$2"
            shift 2
            ;;
        --disk)
            DISK_OVERRIDE="$2"
            shift 2
            ;;
        --list)
            ACTION="list"
            shift
            ;;
        --stop)
            ACTION="stop"
            shift
            ;;
        --destroy)
            ACTION="destroy"
            shift
            ;;
        --cleanup)
            ACTION="cleanup"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --)
            shift
            VM_COMMAND=("$@")
            break
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            usage
            exit 1
            ;;
    esac
done

# Source common functions
# shellcheck source=vm-common.sh
# shellcheck disable=SC1091
source "$SCRIPT_DIR/vm-common.sh"

cd "$SCRIPT_DIR" || exit 1

# Handle list action
if [[ "$ACTION" == "list" ]]; then
  list_vms
  exit 0
fi
