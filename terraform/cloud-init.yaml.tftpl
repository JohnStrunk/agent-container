#cloud-config
hostname: ${hostname}
fqdn: ${hostname}.local
manage_etc_hosts: true

write_files:
%{ if gcp_service_account_key != "" ~}
  - path: /etc/google/application_default_credentials.json
    permissions: '0644'
    content: |
      ${indent(6, gcp_service_account_key)}
%{ endif ~}

users:
  - name: ${default_user}
    uid: ${user_uid}
    shell: /bin/bash
    sudo:
      - "ALL=(ALL) NOPASSWD: /usr/bin/dnf"
      - "ALL=(ALL) NOPASSWD: /usr/bin/rpm"
      - "ALL=(ALL) NOPASSWD: /usr/bin/systemctl"
    ssh_authorized_keys:
%{ for key in ssh_keys ~}
      - ${key}
%{ endfor ~}
  - name: root
    ssh_authorized_keys:
%{ for key in ssh_keys ~}
      - ${key}
%{ endfor ~}

ssh_pwauth: false
disable_root: false

runcmd:
  # Fix user's primary group to match host GID
  - groupmod -g ${user_gid} ${default_user}
  - usermod -g ${user_gid} ${default_user}
  # Add user to docker group
  - usermod -aG docker ${default_user}
  # Add user to libvirt and kvm groups
  - usermod -aG libvirt ${default_user}
  - usermod -aG kvm ${default_user}
  # Initialize libvirt default storage pool
  - mkdir -p /var/lib/libvirt/images
  - chmod 755 /var/lib/libvirt/images
  - virsh --connect qemu:///system pool-define-as default dir --target /var/lib/libvirt/images
  - virsh --connect qemu:///system pool-build default
  - virsh --connect qemu:///system pool-start default
  - virsh --connect qemu:///system pool-autostart default
  # Fix AppArmor for terraform-provider-libvirt
  - |
    cat > /etc/apparmor.d/libvirt/TEMPLATE.qemu <<'APPARMOR_EOF'
    #include <tunables/global>
    profile LIBVIRT_TEMPLATE flags=(attach_disconnected) {
      #include <abstractions/libvirt-qemu>
      /var/lib/libvirt/images/*.qcow2 rwk,
      /var/lib/libvirt/images/*.img rwk,
      /var/lib/libvirt/images/*.iso rwk,
    }
    APPARMOR_EOF
  - systemctl restart libvirtd
  - virsh --connect qemu:///system net-undefine default 2>/dev/null || true
%{ if gcp_service_account_key != "" ~}
  # Configure GCP environment variables
  - |
    cat > /etc/profile.d/gcp-ai-agent.sh <<EOF
    export GOOGLE_APPLICATION_CREDENTIALS=/etc/google/application_default_credentials.json
    export ANTHROPIC_VERTEX_PROJECT_ID="${vertex_project_id}"
    export CLOUD_ML_REGION="${vertex_region}"
    export CLAUDE_CODE_USE_VERTEX="true"
    EOF
  - chmod 644 /etc/profile.d/gcp-ai-agent.sh
%{ endif ~}
  # Create workspace directory
  - mkdir -p /home/${default_user}/workspace
  - chown -R ${user_uid}:${user_gid} /home/${default_user}/workspace
  - chmod 755 /home/${default_user}/workspace

final_message: "Bootc VM ready. All packages pre-installed."
