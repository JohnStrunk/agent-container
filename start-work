#!/bin/bash
set -e -o pipefail

WORKTREE_BASE_DIR=~/src/worktrees
IMAGE_NAME="ghcr.io/johnstrunk/agent-bootc:latest"
BOOTC_DIR="bootc"
GCP_CREDS_DEFAULT="$HOME/.config/gcloud/application_default_credentials.json"

function usage {
    cat - <<EOF
$0: Start using a coding agent on a git worktree (bootc container mode)

Usage: $0 [options] [-b <branch_name>] [command...]

Options:
  -b, --branch <name>            Branch name for git worktree
  --gcp-credentials <path>       Path to GCP service account JSON key file
                                 (default: ~/.config/gcloud/application_default_credentials.json if exists)
  --vertex-project-id <id>       Google Cloud project ID for Vertex AI
                                 (default: \$ANTHROPIC_VERTEX_PROJECT_ID)
  --vertex-region <region>       Google Cloud region for Vertex AI
                                 (default: \$CLOUD_ML_REGION or us-central1)
  -h, --help                     Show this help

Arguments:
  command...                     Optional command to execute in the container

Environment Variables:
  ANTHROPIC_API_KEY             Anthropic API key for Claude (alternative to Vertex)
  GEMINI_API_KEY                Google Gemini API key

Examples:
  $0 -b feature-auth                                              # Start interactive session
  $0 -b feature-auth --gcp-credentials ~/creds.json \\
     --vertex-project-id my-project                               # Use Vertex AI
  $0 -b feature-auth -- claude                                    # Run claude directly
  $0                                                              # Use current directory (no git)
EOF
}

# Check if bootc image needs rebuild
needs_bootc_rebuild() {
    # No image exists
    if ! docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
        echo "bootc image doesn't exist"
        return 0
    fi

    # Get image creation time
    local image_created
    image_created=$(docker image inspect "$IMAGE_NAME" \
        --format '{{.Created}}' | xargs -I{} date -d {} +%s 2>/dev/null || echo 0)

    # Check if any source files are newer than image
    local newest_source
    newest_source=$(find "$BOOTC_DIR" -type f -printf '%T@\n' 2>/dev/null \
        | sort -rn | head -1 | cut -d. -f1 || echo 0)

    if [ "$newest_source" -gt "$image_created" ]; then
        echo "source files modified since last build"
        return 0
    fi

    return 1
}

# Build bootc image if needed
build_bootc_image() {
    echo "Building bootc image from $BOOTC_DIR..."
    docker build -t "$IMAGE_NAME" -f "$BOOTC_DIR/Containerfile" "$BOOTC_DIR/"
}

# Parse command line options
BRANCH_NAME=""
CONTAINER_COMMAND=()
USE_GIT=0
GCP_CREDS_PATH=""
VERTEX_PROJECT_ID="${ANTHROPIC_VERTEX_PROJECT_ID:-}"
VERTEX_REGION="${CLOUD_ML_REGION:-us-central1}"

while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--branch)
            BRANCH_NAME="$2"
            shift 2
            ;;
        --gcp-credentials)
            GCP_CREDS_PATH="$2"
            shift 2
            ;;
        --vertex-project-id)
            VERTEX_PROJECT_ID="$2"
            shift 2
            ;;
        --vertex-region)
            VERTEX_REGION="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --)
            shift
            CONTAINER_COMMAND=("$@")
            break
            ;;
        *)
            CONTAINER_COMMAND=("$@")
            break
            ;;
    esac
done

# Determine if we should use git worktrees
if [[ -n "$BRANCH_NAME" && -d .git ]]; then
    USE_GIT=1
fi

# Check and build image if needed
if needs_bootc_rebuild; then
    build_bootc_image
fi

# Create the base directory if it doesn't exist
mkdir -p "$WORKTREE_BASE_DIR"

# Setup worktree or use current directory
if [[ "$USE_GIT" == 1 ]]; then
    REPO_NAME="$(basename "$(git rev-parse --show-toplevel)")"
    WORKTREE_DIR="$WORKTREE_BASE_DIR/${REPO_NAME}-${BRANCH_NAME}"
    CONTAINER_NAME="${REPO_NAME}-${BRANCH_NAME}"

    # Create worktree if it doesn't exist
    if [[ -d "$WORKTREE_DIR" ]]; then
        echo "Worktree for branch '$BRANCH_NAME' already exists at $WORKTREE_DIR."
    else
        if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
            echo "Adding worktree for existing branch '$BRANCH_NAME'..."
            git worktree add "$WORKTREE_DIR" "$BRANCH_NAME"
        else
            echo "Creating branch '$BRANCH_NAME' from current HEAD and adding worktree..."
            git worktree add -b "$BRANCH_NAME" "$WORKTREE_DIR"
        fi
    fi

    MAIN_REPO_DIR=$(awk '{ print $2 }' "${WORKTREE_DIR}/.git")
    MAIN_REPO_DIR="${MAIN_REPO_DIR%%.git*}"
else
    echo "Using current directory."
    REPO_NAME="$(basename "$(pwd)")"
    WORKTREE_DIR="$(pwd)"
    CONTAINER_NAME="local-$REPO_NAME"
    MAIN_REPO_DIR="$(realpath "$(pwd)")"
fi

# Build mount arguments
MOUNT_ARGS=(
    "-v" "$WORKTREE_DIR:$WORKTREE_DIR:rw"
    "-v" "agent-bootc-cache:$HOME/.cache"
)

# Add main repo mount if using git worktrees
if [[ "$USE_GIT" == 1 ]]; then
    MOUNT_ARGS+=("-v" "$MAIN_REPO_DIR:$MAIN_REPO_DIR:rw")
    echo "Mounting worktree: $WORKTREE_DIR (rw)"
    echo "Mounting main repo: $MAIN_REPO_DIR (rw)"
else
    echo "Mounting current directory: $WORKTREE_DIR (rw)"
fi

# Handle GCP credential injection and Vertex AI configuration
# Check default credential path if not explicitly provided
if [[ -z "$GCP_CREDS_PATH" ]]; then
    GCP_CREDS_PATH="$GCP_CREDS_DEFAULT"
fi

CREDENTIAL_ARGS=()
if [[ -f "$GCP_CREDS_PATH" ]]; then
    echo "Injecting GCP credentials from: $GCP_CREDS_PATH"
    GCP_CREDS_B64=$(base64 -w 0 "$GCP_CREDS_PATH")
    CREDENTIAL_ARGS+=("-e" "GCP_CREDENTIALS_B64=$GCP_CREDS_B64")
    # Set the path where entrypoint.sh will write the credentials
    CREDENTIAL_ARGS+=("-e" "GOOGLE_APPLICATION_CREDENTIALS=$HOME/.config/gcloud/application_default_credentials.json")

    # Enable Vertex AI for Claude Code if credentials provided
    if [[ -z "$VERTEX_PROJECT_ID" ]]; then
        echo "WARNING: GCP credentials provided but --vertex-project-id not set."
        echo "         Claude Code Vertex AI integration will not work without a project ID."
    else
        echo "Configuring Vertex AI: project=$VERTEX_PROJECT_ID, region=$VERTEX_REGION"
        CREDENTIAL_ARGS+=("-e" "ANTHROPIC_VERTEX_PROJECT_ID=$VERTEX_PROJECT_ID")
        CREDENTIAL_ARGS+=("-e" "CLOUD_ML_REGION=$VERTEX_REGION")
        CREDENTIAL_ARGS+=("-e" "CLAUDE_CODE_USE_VERTEX=true")
    fi
fi

# Start the container
if [[ ${#CONTAINER_COMMAND[@]} -gt 0 ]]; then
    echo "Starting bootc container on $WORKTREE_DIR and executing: ${CONTAINER_COMMAND[*]}"
else
    echo "Starting bootc container on $WORKTREE_DIR..."
fi

docker run --rm -it \
    --name "$CONTAINER_NAME" \
    --hostname "$CONTAINER_NAME" \
    "${MOUNT_ARGS[@]}" \
    -w "$WORKTREE_DIR" \
    -e CONTAINER_UID="$(id -u)" \
    -e CONTAINER_GID="$(id -g)" \
    -e HOME="$HOME" \
    -e USER="$USER" \
    "${CREDENTIAL_ARGS[@]}" \
    -e GEMINI_API_KEY \
    -e ANTHROPIC_API_KEY \
    -e ANTHROPIC_MODEL \
    -e ANTHROPIC_SMALL_FAST_MODEL \
    "$IMAGE_NAME" "${CONTAINER_COMMAND[@]}"

# Remove the worktree after exiting the container
if [[ "$USE_GIT" == 1 ]]; then
    git worktree remove "$WORKTREE_DIR" || echo "Not removing worktree $(basename "$WORKTREE_DIR"), it may still be in use."
fi
