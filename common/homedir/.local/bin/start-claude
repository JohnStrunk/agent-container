#! /bin/bash

set -e -o pipefail

function initial_setup() {
    echo "=== Performing initial Claude setup ==="

    # Plugins
    # The official marketplace is built-in, but we have to add it separately
    # so that it can find the plugins before 1st startup
    claude plugin marketplace add anthropics/claude-plugins-official
    local plugins=(
        claude-md-management
        context7
        gopls-lsp
        playwright
        pyright-lsp
        security-guidance
        superpowers
        typescript-lsp
    )
    for plugin in "${plugins[@]}"; do
        claude plugin install "${plugin}@claude-plugins-official"
    done
}


if [ ! -f "${HOME}/.claude/.setup-complete" ]; then  # 1st run
    mkdir -p "${HOME}/.claude"
    initial_setup
    touch "${HOME}/.claude/.setup-complete"
else
    claude plugin marketplace update
fi

exec claude --dangerously-skip-permissions "$@"
