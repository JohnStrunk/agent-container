#!/bin/bash
set -e -o pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common functions
# shellcheck source=vm-common.sh
# shellcheck disable=SC1091
source "$SCRIPT_DIR/vm-common.sh"

# Usage information
usage() {
  cat << EOF
Usage: $0 <branch-name> [workspace-subpath]

Push a git branch to VM workspace over SSH.

Arguments:
  branch-name         Git branch to push (required)
  workspace-subpath   Optional subdirectory within workspace (default: root)

Examples:
  $0 feature-auth              # Push to workspace root
  $0 feature-auth myapp        # Push to workspace/myapp/
  $0 bugfix-123 path/to/repo   # Push to workspace/path/to/repo/

Notes:
  - Must be run from within a git repository
  - Creates/updates git repository on VM
  - Branch will be checked out on VM for working
  - Uses temporary git remote that is cleaned up after push
EOF
}

# Parse arguments
if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
  exit 0
fi

BRANCH_NAME="$1"
WORKSPACE_SUBPATH="${2:-}"

# Verify we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "Error: Must run from within a git repository" >&2
  exit 3
fi

# Verify branch exists
if ! git rev-parse --verify "$BRANCH_NAME" > /dev/null 2>&1; then
  echo "Error: Branch '$BRANCH_NAME' not found" >&2
  exit 3
fi

# Get VM IP and user
VM_IP=$(get_vm_ip "$SCRIPT_DIR")
VM_USER=$(get_vm_user "$SCRIPT_DIR")
SSH_KEY="$SCRIPT_DIR/vm-ssh-key"

# Check VM reachable
check_vm_reachable "$SCRIPT_DIR" "$VM_IP" "$VM_USER"

# Construct remote path
WORKSPACE_BASE=$(get_vm_workspace_path "$SCRIPT_DIR")
if [[ -z "$WORKSPACE_SUBPATH" ]]; then
  REMOTE_PATH="$WORKSPACE_BASE"
else
  REMOTE_PATH="$WORKSPACE_BASE/$WORKSPACE_SUBPATH"
fi

# Initialize git repository on VM if needed
echo "Initializing repository on VM at $REMOTE_PATH"
vm_ssh "$SCRIPT_DIR" "$VM_USER" "$VM_IP" "mkdir -p \"$REMOTE_PATH\" && cd \"$REMOTE_PATH\" && \
  (git rev-parse --git-dir > /dev/null 2>&1 || \
   (git init && git config receive.denyCurrentBranch updateInstead))"

# Set up git to use our SSH key
export GIT_SSH_COMMAND="ssh -i $SSH_KEY -o StrictHostKeyChecking=no"

# Add temporary remote
REMOTE_NAME="vm-workspace-$$"
git remote add "$REMOTE_NAME" "ssh://$VM_USER@$VM_IP$REMOTE_PATH/.git"

# Ensure cleanup happens
cleanup() {
  git remote remove "$REMOTE_NAME" 2>/dev/null || true
}
trap cleanup EXIT

# Push branch to VM
echo "Pushing branch '$BRANCH_NAME' to VM..."
git push "$REMOTE_NAME" "$BRANCH_NAME:$BRANCH_NAME"

# Checkout branch on VM
echo "Checking out branch on VM..."
vm_ssh "$SCRIPT_DIR" "$VM_USER" "$VM_IP" "cd \"$REMOTE_PATH\" && git checkout \"$BRANCH_NAME\""

echo "Done! Branch '$BRANCH_NAME' pushed successfully to VM."
echo "SSH to VM and work in: $REMOTE_PATH"
