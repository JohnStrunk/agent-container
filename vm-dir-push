#!/bin/bash
set -e -o pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common functions
# shellcheck source=vm-common.sh
# shellcheck disable=SC1091
source "$SCRIPT_DIR/vm-common.sh"

# Usage information
usage() {
  cat << EOF
Usage: $0 <local-directory> [workspace-subpath]

Push directory contents to VM workspace over SSH using rsync.

Arguments:
  local-directory     Local directory to push (required)
  workspace-subpath   Optional subdirectory within workspace (default: root)

Examples:
  $0 ./my-project              # Push to workspace root
  $0 ./my-project myapp        # Push to workspace/myapp/
  $0 ~/src/foo bar/baz         # Push to workspace/bar/baz/

Notes:
  - Directory contents (not the directory itself) are copied
  - Excludes: .git/, node_modules/, __pycache__/, .venv/, venv/
  - Uses rsync for efficient incremental transfers
EOF
}

# Parse arguments
if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
  exit 0
fi

LOCAL_DIR="$1"
WORKSPACE_SUBPATH="${2:-}"

# Validate local directory exists
if [[ ! -d "$LOCAL_DIR" ]]; then
  echo "Error: Local directory '$LOCAL_DIR' does not exist" >&2
  exit 1
fi

# Get absolute path
LOCAL_DIR=$(get_absolute_path "$LOCAL_DIR")

# Get VM IP and user
VM_IP=$(get_vm_ip "terraform")
VM_USER=$(get_vm_user "terraform")

# Check VM reachable
check_vm_reachable "terraform" "$VM_IP" "$VM_USER"

# Construct remote path
WORKSPACE_BASE=$(get_vm_workspace_path "terraform")
if [[ -z "$WORKSPACE_SUBPATH" ]]; then
  REMOTE_PATH="$WORKSPACE_BASE/"
else
  REMOTE_PATH="$WORKSPACE_BASE/$WORKSPACE_SUBPATH/"
fi

# Create remote directory if it doesn't exist
vm_ssh "terraform" "$VM_USER" "$VM_IP" "mkdir -p \"$REMOTE_PATH\""

# Perform rsync
echo "Pushing $LOCAL_DIR to $VM_USER@$VM_IP:$REMOTE_PATH"

rsync -avz \
  -e "$(get_rsync_ssh_cmd "terraform")" \
  --exclude='node_modules/' \
  --exclude='__pycache__/' \
  --exclude='.venv/' \
  --exclude='venv/' \
  --exclude='.pytest_cache/' \
  --exclude='*.pyc' \
  --exclude='.DS_Store' \
  "$LOCAL_DIR/" \
  "$VM_USER@$VM_IP:$REMOTE_PATH"

echo "Done! Directory pushed successfully."
