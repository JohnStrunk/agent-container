#!/bin/bash
set -e -o pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common functions
# shellcheck source=vm-common.sh
# shellcheck disable=SC1091
source "$SCRIPT_DIR/vm-common.sh"

# Usage information
usage() {
  cat << EOF
Usage: $0 <local-mount-point>

Mount VM workspace directory to local filesystem using sshfs.

Arguments:
  local-mount-point   Local directory to mount the workspace to (required)

Examples:
  $0 ~/vm-workspace          # Mount workspace to ~/vm-workspace
  $0 /tmp/my-vm-mount        # Mount workspace to /tmp/my-vm-mount

Notes:
  - The mount point directory must exist before mounting
  - The workspace directory will be mounted from the VM
  - Use vm-workspace-unmount to safely unmount when done
  - Requires sshfs to be installed on the host system
EOF
}

# Parse arguments
if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
  exit 0
fi

MOUNT_POINT="$1"

# Check if sshfs is installed
if ! command -v sshfs &> /dev/null; then
  echo "Error: sshfs is not installed" >&2
  echo "Install it with: sudo apt-get install sshfs (Debian/Ubuntu)" >&2
  echo "               or: sudo dnf install fuse-sshfs (Fedora/RHEL)" >&2
  exit 1
fi

# Validate mount point directory exists
if [[ ! -d "$MOUNT_POINT" ]]; then
  echo "Error: Mount point directory '$MOUNT_POINT' does not exist" >&2
  echo "Create it first with: mkdir -p '$MOUNT_POINT'" >&2
  exit 1
fi

# Get absolute path
MOUNT_POINT=$(get_absolute_path "$MOUNT_POINT")

# Check if mount point is already mounted
if mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
  echo "Error: '$MOUNT_POINT' is already a mount point" >&2
  echo "Unmount it first with: vm-workspace-unmount '$MOUNT_POINT'" >&2
  exit 1
fi

# Get VM details
VM_IP=$(get_vm_ip "$SCRIPT_DIR")
VM_USER=$(get_vm_user "$SCRIPT_DIR")
REMOTE_PATH=$(get_vm_workspace_path "$SCRIPT_DIR")
SSH_KEY="$SCRIPT_DIR/vm-ssh-key"

# Check VM reachable
check_vm_reachable "$SCRIPT_DIR" "$VM_IP" "$VM_USER"

# Perform sshfs mount
echo "Mounting $VM_USER@$VM_IP:$REMOTE_PATH to $MOUNT_POINT"

sshfs \
  -o IdentityFile="$SSH_KEY" \
  -o reconnect \
  -o ServerAliveInterval=15 \
  -o ServerAliveCountMax=3 \
  -o StrictHostKeyChecking=no \
  "$VM_USER@$VM_IP:$REMOTE_PATH" \
  "$MOUNT_POINT"

echo "Done! Workspace mounted successfully."
echo "Access your VM workspace at: $MOUNT_POINT"
echo "To unmount: vm-workspace-unmount '$MOUNT_POINT'"
