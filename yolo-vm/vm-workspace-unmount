#!/bin/bash
set -e -o pipefail

# Usage information
usage() {
  cat << EOF
Usage: $0 <local-mount-point>

Unmount VM workspace directory from local filesystem.

Arguments:
  local-mount-point   Local directory where the workspace is mounted (required)

Examples:
  $0 ~/vm-workspace          # Unmount workspace from ~/vm-workspace
  $0 /tmp/my-vm-mount        # Unmount workspace from /tmp/my-vm-mount

Notes:
  - The mount point must be currently mounted
  - Uses fusermount -u for safe unmounting
  - Requires fusermount to be available (part of fuse package)
EOF
}

# Parse arguments
if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
  exit 0
fi

MOUNT_POINT="$1"

# Check if fusermount is installed
if ! command -v fusermount &> /dev/null; then
  echo "Error: fusermount is not installed" >&2
  echo "Install it with: sudo apt-get install fuse (Debian/Ubuntu)" >&2
  echo "               or: sudo dnf install fuse (Fedora/RHEL)" >&2
  exit 1
fi

# Validate mount point directory exists
if [[ ! -d "$MOUNT_POINT" ]]; then
  echo "Error: Mount point directory '$MOUNT_POINT' does not exist" >&2
  exit 1
fi

# Get absolute path
MOUNT_POINT=$(cd "$MOUNT_POINT" && pwd)

# Check if mount point is actually mounted
if ! mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
  echo "Error: '$MOUNT_POINT' is not a mount point" >&2
  echo "Nothing to unmount." >&2
  exit 1
fi

# Perform unmount
echo "Unmounting $MOUNT_POINT"

fusermount -u "$MOUNT_POINT"

echo "Done! Workspace unmounted successfully."
